<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Series Reco</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div class="app-shell">
      <header class="topbar">
        <div class="brand">
          <span class="logo">SR</span>
          <span class="brand-text">Series Reco</span>
        </div>
        <div class="topbar-user" id="topbar-user"></div>
      </header>

      <main class="main">
        <!-- Hero -->
        <section class="hero">
          <div class="hero-text">
            <h1>Retrouvez et recommandez vos s√©ries pr√©f√©r√©es üé¨</h1>
            <p>
              Tape quelques mots-cl√©s, note tes s√©ries, et laisse le moteur te
              proposer de nouvelles id√©es comme sur Netflix ou Disney+.
            </p>
          </div>
        </section>

        <!-- Recherche -->
        <section class="panel" id="search-panel">
          <div class="panel-header">
            <h2>Recherche</h2>
            <p>Les r√©sultats s‚Äôaffichent juste en dessous, fa√ßon catalogue.</p>
          </div>

          <form id="search-form" class="search-bar">
            <input id="q" placeholder="ex : crash avion √Æle, policier, futur..." />
            <button type="submit" class="btn primary">Rechercher</button>
          </form>

          <h3 class="section-title">R√©sultats</h3>
          <div class="cards-row" id="search-results"></div>
        </section>

        <!-- Notation des s√©ries -->
        <section class="panel" id="rate-panel">
          <div class="panel-header">
            <h2>Noter des s√©ries</h2>
            <p>Plus tu notes de s√©ries, plus les recommandations seront pertinentes.</p>
          </div>

          <form id="rate-form" class="form-inline">
            <input id="rate-show" placeholder="Nom de la s√©rie (ex : ncis)" required />
            <select id="rate-value" required>
              <option value="">Note</option>
              <option value="1">1 ‚≠ê</option>
              <option value="2">2 ‚≠ê‚≠ê</option>
              <option value="3">3 ‚≠ê‚≠ê‚≠ê</option>
              <option value="4">4 ‚≠ê‚≠ê‚≠ê‚≠ê</option>
              <option value="5">5 ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
            </select>
            <button type="submit" class="btn primary">Enregistrer</button>
          </form>

          <h3 class="section-title">Mes notes</h3>

          <!-- Cartes de notes -->
          <div class="cards-row" id="ratings-list"></div>
        </section>

        <!-- Recommandations -->
        <section class="panel" id="reco-panel">
          <div class="panel-header">
            <h2>Recommandations pour toi</h2>
            <button id="refresh-reco" class="btn ghost small">Rafra√Æchir</button>
          </div>

          <div class="cards-row" id="reco-results"></div>
        </section>
      </main>
    </div>

    <script>
      /* --------------------- S√©curit√© connexion --------------------- */
      function currentUser() {
        return localStorage.getItem("login");
      }

      if (!currentUser()) {
        window.location.href = "/login";
      }

      /* --------------------- Helpers posters --------------------- */
      function normalizeKey(showName) {
        if (!showName) return "";
        return showName.toLowerCase().replace(/\s+/g, "");
      }

      function getPoster(showName) {
        const key = normalizeKey(showName);
        return `/static/posters/${key}.png`;
      }

      /* --------------------- S√©lecteurs DOM --------------------- */
      const topbarUser = document.getElementById("topbar-user");
      const searchForm = document.getElementById("search-form");
      const searchResults = document.getElementById("search-results");
      const rateForm = document.getElementById("rate-form");
      const ratingsList = document.getElementById("ratings-list");
      const recoResults = document.getElementById("reco-results");
      const refreshRecoBtn = document.getElementById("refresh-reco");

      /* --------------------- Header --------------------- */
      if (topbarUser && currentUser()) {
        topbarUser.textContent = "Connect√© : " + currentUser();
      }

      /* --------------------- Cartes --------------------- */
      function renderShowCards(container, items, { showScore } = {}) {
        if (!items || !items.length) {
          container.innerHTML = '<p class="empty">Rien pour l‚Äôinstant‚Ä¶</p>';
          return;
        }

        container.innerHTML = items
          .map((s) => {
            const scoreHtml =
              showScore && s.score
                ? `<p class="show-score">Score : ${s.score.toFixed(0)}</p>`
                : "";
            return `
              <article class="show-card">
                <div class="show-poster">
                  <img src="${getPoster(s.show_name)}"
                       alt="${s.show_name}"
                       loading="lazy"
                       onerror="this.onerror=null; this.src='/static/posters/default.png';" />
                </div>
                <div class="show-meta">
                  <h3 class="show-title">${s.show_name}</h3>
                  ${scoreHtml}
                </div>
              </article>
            `;
          })
          .join("");
      }

      /* Cartes pour les notes */
      function renderRatingCards(items) {
        if (!items || !items.length) {
          ratingsList.innerHTML =
            '<p class="empty">Aucune note pour l‚Äôinstant.</p>';
          return;
        }

        ratingsList.innerHTML = items
          .map((r) => {
            return `
              <article class="show-card">
                <div class="show-poster">
                  <img src="${getPoster(r.show_name)}"
                       alt="${r.show_name}"
                       loading="lazy"
                       onerror="this.onerror=null; this.src='/static/posters/default.png';" />
                </div>
                <div class="show-meta">
                  <h3 class="show-title">${r.show_name}</h3>
                  <p class="show-score">${r.rating} ‚≠ê</p>
                </div>
              </article>
            `;
          })
          .join("");
      }

      /* --------------------- Recherche --------------------- */
      function groupByShow(results) {
        const best = {};
        for (const r of results || []) {
          if (!best[r.show_name] || r.score > best[r.show_name].score) {
            best[r.show_name] = r;
          }
        }
        return Object.values(best);
      }

      if (searchForm) {
        searchForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const q = document.getElementById("q").value.trim();
          if (!q) return;

          searchResults.innerHTML =
            '<p class="info">Recherche en cours...</p>';

          try {
            const resp = await fetch(`/search?q=${encodeURIComponent(q)}`);
            const data = await resp.json();
            renderShowCards(searchResults, groupByShow(data.results), {
              showScore: true,
            });
          } catch (err) {
            searchResults.innerHTML = `<p class="error">${err.message}</p>`;
          }
        });
      }

      /* --------------------- Notes --------------------- */
      async function loadRatings() {
        const user = currentUser();
        try {
          const resp = await fetch(`/user/ratings/${user}`);
          const data = await resp.json();
          renderRatingCards(data.ratings);
        } catch {
          ratingsList.innerHTML = `<p class="error">Erreur de chargement</p>`;
        }
      }

      rateForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const user = currentUser();
        if (!user) {
          alert("Tu dois √™tre connect√© pour noter des s√©ries.");
          window.location.href = "/login";
          return;
        }

        const showName = document.getElementById("rate-show").value.trim();
        const rating = parseInt(
          document.getElementById("rate-value").value,
          10
        );

        if (!showName || !rating) {
          return;
        }

        try {
          const resp = await fetch("/user/rate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_id: user,
              show_name: showName,
              rating: rating,
            }),
          });

          if (!resp.ok) {
            // On r√©cup√®re le message envoy√© par FastAPI
            const data = await resp.json().catch(() => ({}));
            const msg =
              data.detail || "Erreur lors de l‚Äôenregistrement.";
            throw new Error(msg);
          }

          await loadRatings();
          await loadRecommendations();
          rateForm.reset();
        } catch (err) {
          alert(err.message);
        }
      });

      /* --------------------- Recommandations --------------------- */
      async function loadRecommendations() {
        const user = currentUser();
        recoResults.innerHTML =
          '<p class="info">Calcul des recommandations...</p>';

        try {
          const resp = await fetch(`/user/recommend/${user}`);
          const data = await resp.json();
          renderShowCards(recoResults, data.results, { showScore: true });
        } catch {
          recoResults.innerHTML = `<p class="error">Erreur de chargement</p>`;
        }
      }

      refreshRecoBtn.addEventListener("click", loadRecommendations);

      /* --------------------- Initialisation --------------------- */
      loadRatings();
      loadRecommendations();
    </script>
  </body>
</html>
